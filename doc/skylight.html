<!DOCTYPE html>
<html>
<head>
  <title>Skylight updates</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <style type="text/css">
  html, body { background-color: #ddd; padding: 0; margin: 0; font-family: sans-serif }
  #toolbar { background-color: #f0f0f0; padding: 0.5em }
  #brush { margin-left: 2em }
  #terrain { border: 2px solid black; background-color: white }
  </style>
</head>
<body>
<div id="toolbar">
  <span style="font-weight: bold">Map</span>:
  <input type="button" value="Clear all" onclick="skylight.clear()">
  <input type="button" value="Save" onclick="skylight.save()">

  <span style="margin-left: 2em; font-weight: bold">Debug</span>:
  <input type="checkbox" id="stepbystep" onclick="skylight.toggleDebug()">
  <label for="stepbystep"> Step by step</label> <input type="button" value="Next" disabled>
  <span id="brush">
    <b>Brush</b>:
    <input type="radio" name="brush" id="brush0" value="0" checked><label for="brush0">Opaque</label>
    <input type="radio" name="brush" id="brush1" value="1"><label for="brush1">Leaves</label>
    <input type="radio" name="brush" id="brush2" value="2"><label for="brush2">Water</label>
  </span>

  <span id="msg"></span>
</div>
<canvas id="terrain" width="1280" height="800">
</canvas>

<script type="text/javascript">
var skylight = {
	columns: 64,
	rows:    40,
	cellSz:  20,
	terrain: null,
	light:   null,
	canvas:  null,
	brush:   0,

	init: function() {
		this.terrain = new Uint8Array(this.columns * this.rows)
		this.light   = new Uint8Array(this.columns * this.rows)
		this.canvas  = document.getElementById("terrain")
		var map = localStorage.getItem("skylightMap")
		if (map)
		{
			for (var i = 0; i < map.length; i ++)
			{
				var chr = map.charCodeAt(i)
				this.terrain[i] = chr & 3
				this.light[i]   = chr >> 3
			}
		}
		else this.light.fill(8)
		
		this.canvas.addEventListener("click", this.mouse)
	},

	mouse: function(evt) {
      // javascript DOM garbage: can't even return position relative to content (note: 2 = border thickness :-/)
      var rect = evt.target.getBoundingClientRect()
      var x = evt.clientX - rect.left - 2
      var y = evt.clientY - rect.top  - 2

      var index = Math.floor(x / skylight.cellSz) + Math.floor(y / skylight.cellSz) * skylight.columns
	  skylight.terrain[index] = skylight.brush

	  //
	},

	render: function() {
		//
	},
}
skylight.init()
</script>
</body>
</html>